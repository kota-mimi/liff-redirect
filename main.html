<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>LIFF Final Investigation</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body { font-family: sans-serif; padding: 15px; word-break: break-all; }
      .container { border: 2px solid #000; padding: 15px; border-radius: 8px; margin-bottom: 20px;}
      .error { border-color: #f00; background-color: #fff0f0; }
      h1 { font-size: 20px; }
      h2 { font-size: 16px; border-bottom: 1px solid #ccc; padding-bottom: 5px; }
      p, li { font-size: 14px; }
      strong { color: #f00; }
      ul { padding-left: 20px; }
    </style>
  </head>
  <body>
    <div id="debug-container" class="container">
      <h1>最終調査モード</h1>
      <p>LIFFを初期化しています...</p>
    </div>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
      // ★ ここに、さっきあなたが教えてくれた新しいGASのURLを入れます
      const GAS_API_URL = "https://script.google.com/macros/s/AKfycbxpEW9vA8WEvFYevhIA-xK7akHzNgCQ3JRHBAdDh1fX8FtC6RTO5yeVjgaspTFLS5f8uw/exec";

      // ★ ここに、あなたが最後に作った一番新しいLIFF IDを入れます
      const LIFF_ID = "2007869731-OGxpgeZj";

      const container = document.getElementById("debug-container");

      // 結果を表示するための関数
      function displayResult(data) {
        let listHtml = '<ul>';
        data.sheet_list.forEach(id => {
          listHtml += `<li>"${id}" (長さ: ${id.length})</li>`;
        });
        listHtml += '</ul>';

        container.innerHTML = `
          <h1>調査結果</h1>
          <p>この情報をもとに、原因を特定します。</p>
          <hr>
          <h2>スマホからGASが受け取ったID:</h2>
          <p><strong>"${data.received}" (長さ: ${data.received.length})</strong></p>
          <hr>
          <h2>スプレッドシートにあるIDの全リスト:</h2>
          ${listHtml}
        `;
      }
      
      // エラー表示用の関数
      function displayError(message) {
        container.innerHTML = `<div class="error"><h1>エラー</h1><p>${message}</p></div>`;
      }

      async function main() {
        try {
          await liff.init({ liffId: LIFF_ID });

          if (!liff.isLoggedIn()) {
            liff.login();
            return;
          }

          const profile = await liff.getProfile();
          const userId = profile.userId;

          // GASの調査APIにアクセスする
          const response = await fetch(`${GAS_API_URL}?userId=${userId}`);
          const result = await response.json();

          if (result.status === 'success') {
            // 成功したら、調査結果を表示
            displayResult(result.data);
          } else {
            // GAS側でエラーが起きたら表示
            displayError(result.message);
          }
        } catch (err) {
          // 通信エラーなどが起きたら表示
          displayError(`処理中にエラーが発生しました: ${err.message}`);
        }
      }

      main();
    </script>
  </body>
</html>
