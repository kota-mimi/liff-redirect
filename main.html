<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>LIFF Error Trap</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body { font-family: sans-serif; padding: 15px; word-break: break-all; }
      .container { border: 2px solid #000; padding: 15px; border-radius: 8px; }
      .error { border-color: #f00; background-color: #fff0f0; }
      h1 { font-size: 20px; }
      p { margin: 10px 0; font-size: 14px; }
      strong { color: #f00; }
    </style>
  </head>
  <body>
    <div id="debug-container" class="container">
      <!-- ã“ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‹ã©ã†ã‹ãŒé‡è¦ -->
      <h1>èª¿æŸ»ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼“</h1>
      <p>LIFFã‚’åˆæœŸåŒ–ã—ã¦ã„ã¾ã™...</p>
    </div>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
      // ã‚¨ãƒ©ãƒ¼ã‚’ç”»é¢ã«è¡¨ç¤ºã™ã‚‹ãŸã‚ã®é–¢æ•°
      function displayError(title, error) {
        const container = document.getElementById('debug-container');
        container.classList.add('error');
        let errorMessage = error.message ? error.message : JSON.stringify(error);
        container.innerHTML = `
          <h1>${title}</h1>
          <p><strong>ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:</strong></p>
          <p>${errorMessage}</p>
          <p><strong>ã‚¨ãƒ©ãƒ¼è©³ç´°:</strong></p>
          <p>${error.stack ? error.stack : 'N/A'}</p>
        `;
      }

      async function main() {
        try {
          // 1. LIFFã®åˆæœŸåŒ–
          document.getElementById('debug-container').innerHTML += '<p>liff.init() ã‚’å®Ÿè¡Œã—ã¾ã™...</p>';
          await liff.init({ liffId: "2007869731-OGxpgeZj" });
          document.getElementById('debug-container').innerHTML += '<p style="color:green;">âœ… liff.init() æˆåŠŸ</p>';

          // 2. ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã®ç¢ºèª
          if (!liff.isLoggedIn()) {
            document.getElementById('debug-container').innerHTML += '<p>ãƒ­ã‚°ã‚¤ãƒ³ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«ç§»å‹•ã—ã¾ã™ã€‚</p>';
            liff.login();
            return;
          }
          document.getElementById('debug-container').innerHTML += '<p style="color:green;">âœ… ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã§ã™</p>';

          // 3. ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®å–å¾—
          document.getElementById('debug-container').innerHTML += '<p>liff.getProfile() ã‚’å®Ÿè¡Œã—ã¾ã™...</p>';
          const profile = await liff.getProfile();
          document.getElementById('debug-container').innerHTML += '<p style="color:green;">âœ… ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾— æˆåŠŸ</p>';

          // 4. æœ€çµ‚çµæœã®è¡¨ç¤º
          const userId = profile.userId;
          const gasUrl = `https://script.google.com/macros/s/AKfycbyNdpFFQ31wKEsbQawdYlIgyaYyu6VhDROCqcWWJyE0xXtwlBqPGfmPs1cp06BP5UY8kA/exec`;
          const redirectUrl = `${gasUrl}?userId=${encodeURIComponent(userId)}`;

          document.getElementById('debug-container').innerHTML = `
            <h1>ğŸ‰ ã™ã¹ã¦æˆåŠŸ ğŸ‰</h1>
            <p><strong>å–å¾—ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ID:</strong><br>${userId}</p>
            <p><strong>ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå…ˆURL:</strong><br>${redirectUrl}</p>
            <p>ã“ã®ç”»é¢ãŒè¡¨ç¤ºã•ã‚ŒãŸã¨ã„ã†ã“ã¨ã¯ã€ã™ã¹ã¦ã®å‡¦ç†ãŒæ­£å¸¸ã«å®Œäº†ã—ãŸè¨¼æ‹ ã§ã™ã€‚</p>
          `;

        } catch (err) {
          // â˜…â˜…â˜…ã©ã‚“ãªã‚¨ãƒ©ãƒ¼ã§ã‚‚ã“ã“ã§æ•ã¾ãˆã‚‹â˜…â˜…â˜…
          displayError("å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ", err);
        }
      }

      main();
    </script>
  </body>
</html>
